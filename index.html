<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>GC97 meter</title>
<meta name="viewport" content="width=device-width"><!--<meta http-equiv="Refresh" content="120" />--><meta name="robots" content="none" /><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /><meta http-equiv="Pragma" content="no-cache" /><meta http-equiv="Expires" content="0" /><meta name="mobile-web-app-capable" content="yes" /><meta name="apple-mobile-web-app-capable" content="yes" />
<style type="text/css">
html{height:100%;margin:0;padding:0}
body{height:100%;color:#333;background:#d7ecf5;background:linear-gradient(45deg,rgba(215,236,245,1) 0%,rgba(244,252,255,1) 50%,rgba(248,253,255,1) 100%);margin:0;padding:0;border:0;font-family:Arial,Helvetica,sans-serif;font-weight:400;font-size:.95rem;line-height:1.1;min-width:240px;min-height:200px}
#preloader{position:absolute;top:0;left:0;height:100%;width:100%;display:none;z-index:999}
#preloader.visible{display:block}
.preloader-content{transform:translateY(-35%);top:35%;left:0;position:absolute;width:100%;color:#69c4e1;text-align:center}
.preloader .preloader-box{padding:1em;text-wrap:none;white-space:nowrap;min-width:160px;max-width:200px}
#preloader-text{transform:translateY(-75%);top:75%;font-size:.9em;font-weight:400;position:absolute;color:#10629d;width:calc(100% - 2em);text-align:center}
#content{width:100%;text-align:center;white-space:nowrap;text-wrap:none}
#header{display:block;top:0;left:0;background-color:#5a5a5a;color:#f1f1f1;border-bottom:1px solid #fff;padding:1.7ex 1em;vertical-align:middle;font-size:.9em;height:2.2em;z-index:2}
#header .icon,#footer .icon{color:#f5f5f5}
#footer{position:fixed;width:100%;bottom:0;left:0;background-color:#5a5a5a;color:#e0e0e0;border-top:1px solid #fff;padding:1ex 1em;font-size:.9em;z-index:2}
a.footer_link{color:#f0f0f0;text-decoration:none}
a.footer_link:hover{color:#fff;text-decoration:underline}
#overlay{width:100%;height:100%;z-index:998;display:none;background:#ccc;opacity:.33;position:absolute;left:0;top:0}
.overlay #overlay{display:block}
.overlay #main-area{opacity:.5}
.shadow{box-shadow:4px 4px 6px 6px rgba(150,150,150,0.45)}
.visible{display:block}
.hidden{display:none}
.popup{z-index:9999;background:#fff;opacity:1;min-width:150px;min-height:80px;max-width:90%;max-height:90%;white-space:nowrap;border:1px solid #bebebe!important}
#popup-header{background:#f0f0f0;border-bottom:1px solid #e0e0e0;border-top-left-radius:6px;border-top-right-radius:6px;font-weight:600;display:inline-block;width:calc(100% - 4px);line-height:1.2em;padding:6px 0 2px 4px;text-align:left}
#popup-buttons{position:absolute;bottom:0;right:0;padding:.7em 1em;text-align:right;font-size:.85em;text-wrap:none;white-space:nowrap;border-top:1px solid #efefef;margin-top:6px;width:calc(100% - 2em)}
#popup-content{padding:1ex;opacity:1!important;font-size:.9em;width:100%}
#popup-close{text-align:right;margin:0 1ex 0 0;font-size:.8em;font-weight:600;color:#306ca5;display:inline-block;float:right}
#popup-header.hidden,#popup-close.hidden,#popup-buttons.hidden{display:none}
input[type="text"],input[type="password"],textarea{font-family:Arial,Helvetica,sans-serif;color:#000;background:#fafafa;border:1px solid #c6c6c6;border-radius:3px;padding:3px 5px;font-size:1.1em}
input:focus,textarea:focus{background:#fffbe7;outline:none}
.round-box{text-align:center;vertical-align:middle;min-width:70px;min-height:70px;border:1px solid #DDD;border-radius:6px;box-shadow:1px 1px 10px 2px rgba(150,150,150,0.1);background:#fff;transition:color .5s linear,background .5s linear,border .5s linear}
.round-box:hover{border:1px solid #AAA;-o-transition:color .5s linear,background .5s linear,border .5s linear;-moz-transition:color .5s linear,background .5s linear,border .5s linear;-webkit-transition:color .5s linear,background .5s linear,border .5s linear;transition:color .5s linear,background .5s linear,border .5s linear;box-shadow:2px 2px 15px 2px rgba(150,150,150,0.3)}
.center{position:absolute;margin:auto;top:0;right:0;bottom:0;left:0;width:100px;height:100px}
.icon{color:#2975ae;width:1.25em;height:1.25em;vertical-align:text-bottom;display:inline-block}
.icon a:hover{color:#2a96e6}
.button{background:#54869c;color:#f0f0f0;padding:.65ex 2ex;vertical-align:middle;border-radius:4px;border:1px solid #066b97;opacity:.85;text-decoration:none!important;font-weight:600;font-size:1.05em;text-align:center;display:inline-block;cursor:pointer}
.button:hover:not(:disabled):not(.disabled){opacity:1;color:#fff;background:#3b758f;box-shadow:2px 2px 2px 2px rgba(133,133,133,0.15)}
.button > .icon{color:#f0f0f0;margin-right:2px}
.button.hidden{display:none}
.button:disabled,.button.disabled{background:#a4a4a4!important;color:#cecece!important;cursor:default}
.button_light{background:#f5f5f5;border:1px solid #aaa;color:#1a6a92}
.button_light:hover{background:#c4d3d7;border:1px solid #6592ac;color:#325a6f}
.button_light > .icon{color:#1a6a92!important}
.button_light:disabled,.button_light.disabled{background:#e5e5e5!important;color:#9f9f9f!important}
.statuses{display:table}
.status{padding-right:2ex;white-space:nowrap;text-wrap:none;display:table-cell;opacity:.8}
.status:hover{opacity:1}
.status svg{width:1.2rem;height:1.2rem;margin-right:1px;vertical-align:text-bottom}
.status .visible{display:inline-block}
.status-gray{color:#9f9f9f!important}
.status-off{color:#f3a29a!important}
.status-on{color:#d2eaca!important}
.overlay .gc_case{opacity:.03;transition:background .25s linear,opacity .25s linear}
.gc_case{background:#686868;padding:2em 3.5em;width:17rem;height:8.8rem;border-radius:8px;border:2px #878787 solid;transition:background .25s linear,color .25s linear,border .25s linear,opacity .25s linear}
.gc_case:hover{background:#565656;box-shadow:4px 4px 12px 12px rgba(150,150,180,0.25);border:2px solid #484848;transition:background .25s linear,color .25s linear,border .25s linear}
.gc_case label:after{font-family:Arial;content:'\2022';color:#e0e0e0;position:absolute;right:.55em;top:7rem;font-size:2.2rem}
.gc_case label:nth-child(2):after{padding-top:2.2rem}
a.gc_buttons,a.gc_buttons:hover{text-decoration:none;text-shadow:-1px -1px 1px rgba(0,0,0,0.7)}
.gc_case a.gc_buttons:hover label:after{cursor:pointer;text-shadow:-2px -2px 1px rgba(0,0,0,0.99);color:#fff}
.gc_screen.offline{background:#d9d9d8;color:gray}
.gc_screen{background:#b0e977;border:1px solid #515151;height:100%;width:100%;border-radius:4px;vertical-align:top;text-align:left;font-size:1.1rem;opacity:.9;color:#444;transition:background .25s linear,color .25s linear,border .25s linear,opacity .25s linear}
.gc_case:hover .gc_screen:not(.offline){color:#000;background:#b0e977;border:1px solid #c2c2c2;opacity:1;transition:background .25s linear,color .25s linear,border .25s linear,opacity .25s linear}
.gc_unit{font-weight:600;font-size:.75em;margin-left:.1em}
#not_connected{width:100%;height:100%;margin-top:15%;text-align:center;color:#9cb1b5;line-height:1.2}
#not_connected a{color:#9cb1b5;text-decoration:none}
#gc_temp{position:absolute;left:2.3em;top:1.4em;font-size:1.5em;display:inline-block;font-weight:700}
#gc_batt_icon{position:absolute;right:3.2em;top:2.2em;vertical-align:text-bottom;float:right;width:50%;text-align:right}
#gc_batt_perc{display:inline-block;font-size:1.4em;top:-.1em;position:absolute;right:3.5em;font-weight:700}
#gc_batt_body{border:3px solid #333;border-radius:2px;width:4.7em;height:1.25em;display:inline-block;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box}
.offline #gc_batt_body{border-color:#aeaeae}
#gc_batt_contact{background:#333;width:3px;height:.6em;display:inline-block;margin-bottom:.35em}
.offline #gc_batt_contact{background:#aeaeae}
#gc_time_row{font-size:.9em;font-weight:700;text-align:right;display:block;padding-right:1ex;vertical-align:baseline}
#gc_time{display:inline-block}
#gc_charging{display:inline-block}
#gc_charging.hidden{display:none}
#gc_voltage{position:absolute;left:1.55em;top:2.4em;font-size:2.15em;display:inline-block;font-weight:800}
#gc_current{position:absolute;right:1.55em;top:2.4em;text-align:right;font-size:2.15em;display:inline-block;font-weight:800}
#gc_power{position:absolute;left:2.45em;top:5.7em;font-size:1.4em;display:inline-block;font-weight:700}
#gc_capacity{position:absolute;right:2.3em;top:5.7em;text-align:right;font-size:1.4em;display:inline-block;font-weight:700}
.blink_red{animation:blink_red 1s ease-in-out infinite}
.spin{animation:spin 2s linear infinite}
.spin-hourglass{animation:spin 4s ease-in-out infinite}
@keyframes blink_red {
50%{background:#fb4d3c}
}
@keyframes spin {
0%{transform:rotate(0deg)}
100%{transform:rotate(1turn)}
}
@keyframes page_loader {
0%{opacity:0;transform:translateX(-80px) scale(0.5)}
33%{opacity:1;transform:translateX(0px) scale(2)}
66%{opacity:1;transform:translateX(0px) scale(2)}
100%{opacity:0;transform:translateX(80px) scale(0.5)}
}
@-webkit-keyframes page_loader {
0%{opacity:0;-webkit-transform:translateX(-80px)}
33%{opacity:1;-webkit-transform:translateX(0px)}
66%{opacity:1;-webkit-transform:translateX(0px)}
100%{opacity:0;-webkit-transform:translateX(80px)}
}
@media only screen and (min-width: 1200px) {
.gc_case{transform:scale(1.15)}
}
@media only screen and (max-width: 800px) {
body{font-size:.9rem}
.nowide800{display:none}
.gc_case{transform:scale(0.95)}
}
@media only screen and (max-width: 600px) {
body{font-size:.85rem}
.nowide600{display:none}
.gc_case{transform:scale(0.85)}
#header,#footer{font-size:.85em}
}
</style>
</head><body id="body" class="overlay">
<div id="overlay"></div><form id="theForm" name="theForm" method="post" enctype="multipart/form-data">
<div id="preloader" class="preloader visible"><div class="preloader-box round-box center"><div class="preloader-content"><svg width="3em" height="3em" class="spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49 0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156 0c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"></path></svg></div><div id="preloader-text">Loading...</div></div></div>
<div id="popup" class="popup round-box center hidden shadow"><div id="popup-header"><span id="popup-header-content"></span><div id="popup-close"><div class="icon"><a href="" onclick="popup(false); return false;" title="Close dialog"><svg style="width:16px;height:16px" viewBox="0 0 24 24"><path fill="currentColor" d="M20 6.91L17.09 4L12 9.09L6.91 4L4 6.91L9.09 12L4 17.09L6.91 20L12 14.91L17.09 20L20 17.09L14.91 12L20 6.91Z" /></svg></a></div></div></div><div id="popup-content"></div><div id="popup-buttons"></div></div>
<div id="main-area"><div id="header"><div style="font-size:1.75em; display: inline-block;"><div class="icon"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 20H4V6H12M12.67 4H11V2H5V4H3.33C2.6 4 2 4.6 2 5.33V20.67C2 21.4 2.6 22 3.33 22H12.67C13.41 22 14 21.41 14 20.67V5.33C14 4.6 13.4 4 12.67 4M11 16H5V19H11V16M11 7H5V10H11V7M11 11.5H5V14.5H11V11.5M23 10H20V3L15 13H18V21" /></svg></div><b>GC-97 meter</b></div><div style="float:right;">
<a href="" class="button button_light" onclick="reboot(); return false;" title="Reboot controller" style="margin-right:1ex;"><div class="icon"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z" /></svg></div>Reboot</a>
<a href="" class="button button_light" onclick="settings(true); return false;" title="Settings"><div class="icon"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11L19.5,12L19.43,13L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.66L7.86,15.62C8.63,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.66L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z" /></svg></div>Settings</a>
</div></div>
<div id="content" class="content center"><div class="round-box center gc_case"><a href="" onclick="settings(true); return false;" class="gc_buttons" title="Settings"><label></label><label style="margin-top:80%;"></label></a><div id="gc_screen" class="gc_screen">
<div id="not_connected" class="hidden"><a href="" onclick="settings(true); return false;" title="Click to edit the connection settings"><svg class="spin-hourglass" width="2em" height="2em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M360 0H24C10.745 0 0 10.745 0 24v16c0 13.255 10.745 24 24 24 0 90.965 51.016 167.734 120.842 192C75.016 280.266 24 357.035 24 448c-13.255 0-24 10.745-24 24v16c0 13.255 10.745 24 24 24h336c13.255 0 24-10.745 24-24v-16c0-13.255-10.745-24-24-24 0-90.965-51.016-167.734-120.842-192C308.984 231.734 360 154.965 360 64c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24zm-75.078 384H99.08c17.059-46.797 52.096-80 92.92-80 40.821 0 75.862 33.196 92.922 80zm.019-256H99.078C91.988 108.548 88 86.748 88 64h208c0 22.805-3.987 44.587-11.059 64z"></path></svg><br />Not connected</a></div>
<div style="width:100%; height:100%;"><div id="gc_temp" title="Temperature"></div>
<div id="gc_batt_icon" title="SOC (battery level)"><div id="gc_batt_perc"></div><div id="gc_batt_body"></div><div id="gc_batt_contact"></div><div id="gc_time_row"><div id="gc_charging" title="In charging now" class="hidden"><svg style="height:1.0em; width:1.0em;" viewBox="0 0 24 24"><path fill="currentColor" d="M16,7V3H14V7H10V3H8V7H8C7,7 6,8 6,9V14.5L9.5,18V21H14.5V18L18,14.5V9C18,8 17,7 16,7Z" /></svg></div><div id="gc_time" title="Current phase (on load, charging) time"></div></div></div>
<div id="gc_voltage" title="Voltage"></div><div id="gc_current" title="Current"></div><div id="gc_power" title="Power"></div><div id="gc_capacity" title="Remaining capacity (calculated)"></div>
</div></div></div>
<div id="footer"><div class="statuses"><a href="" onclick="settings(true); return false;" class="gc_buttons">
<div id="wifi" class="icon status status-gray" title="Wi-fi"><span class="on hidden"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,21L15.6,16.2C14.6,15.45 13.35,15 12,15C10.65,15 9.4,15.45 8.4,16.2L12,21M12,3C7.95,3 4.21,4.34 1.2,6.6L3,9C5.5,7.12 8.62,6 12,6C15.38,6 18.5,7.12 21,9L22.8,6.6C19.79,4.34 16.05,3 12,3M12,9C9.3,9 6.81,9.89 4.8,11.4L6.6,13.8C8.1,12.67 9.97,12 12,12C14.03,12 15.9,12.67 17.4,13.8L19.2,11.4C17.19,9.89 14.7,9 12,9Z" /></svg></span><span class="off"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3C7.8 3 3.7 4.4 .4 7C4.3 11.8 8.2 16.7 12 21.5C14.3 18.6 16.7 15.7 19 12.8V9.6L12 18.3L3.3 7.4C5.9 5.8 8.9 5 12 5C15.1 5 18.1 5.9 20.7 7.4L20.3 8H22.9C23.2 7.7 23.4 7.3 23.7 7C20.3 4.4 16.2 3 12 3M21 10V16H23V10M21 18V20H23V18" /></svg></span><span class="status-label nowide600"></span></div>
<div id="ip" class="icon status status-gray" title="IP address"><span class="on hidden"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M15,20A1,1 0 0,0 14,19H13V17H17A2,2 0 0,0 19,15V5A2,2 0 0,0 17,3H7A2,2 0 0,0 5,5V15A2,2 0 0,0 7,17H11V19H10A1,1 0 0,0 9,20H2V22H9A1,1 0 0,0 10,23H14A1,1 0 0,0 15,22H22V20H15M7,15V5H17V15H7M10,6H8V14H10V6M14,6H11V14H13V12H14A2,2 0 0,0 16,10V8A2,2 0 0,0 14,6M14,10H13V8H14V10Z" /></svg></span><span class="off"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M15,20A1,1 0 0,0 14,19H13V17H17A2,2 0 0,0 19,15V5A2,2 0 0,0 17,3H7A2,2 0 0,0 5,5V15A2,2 0 0,0 7,17H11V19H10A1,1 0 0,0 9,20H2V22H9A1,1 0 0,0 10,23H14A1,1 0 0,0 15,22H22V20H15M7,15V5H17V15H7M11.95,6C11.17,6 10.55,6.18 10.07,6.5C9.61,6.89 9.38,7.4 9.39,8.1L9.4,8.13H11.11C11.12,7.86 11.2,7.65 11.36,7.5C11.5,7.38 11.72,7.31 11.95,7.31C12.22,7.31 12.45,7.4 12.61,7.56C12.77,7.73 12.85,7.96 12.85,8.22C12.85,8.5 12.78,8.75 12.64,8.95C12.5,9.16 12.33,9.33 12.1,9.5C11.65,9.78 11.34,10.05 11.17,10.29C11,10.5 10.89,10.89 10.89,11.33H12.67C12.67,11.06 12.7,10.84 12.78,10.68C12.86,10.5 13,10.36 13.24,10.21C13.64,10 13.97,9.74 14.22,9.39C14.5,9.03 14.62,8.67 14.62,8.22C14.62,7.55 14.38,7 13.9,6.61C13.42,6.2 12.77,6 11.95,6M10.89,12.22V14H12.67V12.22H10.89Z" /></svg></span><span class="status-label"></span></div>
<div id="mqtt" class="icon status status-gray" title="MQTT server"><span class="on hidden"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,19H14A1,1 0 0,1 15,20H22V22H15A1,1 0 0,1 14,23H10A1,1 0 0,1 9,22H2V20H9A1,1 0 0,1 10,19H11V17H4A1,1 0 0,1 3,16V12A1,1 0 0,1 4,11H20A1,1 0 0,1 21,12V16A1,1 0 0,1 20,17H13V19M4,3H20A1,1 0 0,1 21,4V8A1,1 0 0,1 20,9H4A1,1 0 0,1 3,8V4A1,1 0 0,1 4,3M9,7H10V5H9V7M9,15H10V13H9V15M5,5V7H7V5H5M5,13V15H7V13H5Z" /></svg></span><span class="off"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,19H14A1,1 0 0,1 15,20H15.73L13,17.27V19M22,20V21.18L20.82,20H22M21,22.72L19.73,24L17.73,22H15A1,1 0 0,1 14,23H10A1,1 0 0,1 9,22H2V20H9A1,1 0 0,1 10,19H11V17H4A1,1 0 0,1 3,16V12A1,1 0 0,1 4,11H6.73L4.73,9H4A1,1 0 0,1 3,8V7.27L1,5.27L2.28,4L21,22.72M4,3H20A1,1 0 0,1 21,4V8A1,1 0 0,1 20,9H9.82L7,6.18V5H5.82L3.84,3C3.89,3 3.94,3 4,3M20,11A1,1 0 0,1 21,12V16A1,1 0 0,1 20,17H17.82L11.82,11H20M9,7H10V5H9V7M9,15H10V14.27L9,13.27V15M5,13V15H7V13H5Z" /></svg></span><span class="status-label nowide600"></span></div>
<div id="gc" class="icon status status-gray" title="GC97 meter"><span class="on hidden"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M6,4H18V5H21V7H18V9H21V11H18V13H21V15H18V17H21V19H18V20H6V19H3V17H6V15H3V13H6V11H3V9H6V7H3V5H6V4M11,15V18H12V15H11M13,15V18H14V15H13M15,15V18H16V15H15Z" /></svg></span><span class="off"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M11,13H13V7H11M21,4H15V10L17.24,7.76C18.32,8.85 19,10.34 19,12C19,14.61 17.33,16.83 15,17.65V19.74C18.45,18.85 21,15.73 21,12C21,9.79 20.09,7.8 18.64,6.36M11,17H13V15H11M3,12C3,14.21 3.91,16.2 5.36,17.64L3,20H9V14L6.76,16.24C5.68,15.15 5,13.66 5,12C5,9.39 6.67,7.17 9,6.35V4.26C5.55,5.15 3,8.27 3,12Z" /></svg></span><span class="status-label"></span></div>
</a></div>
<div class="nowide600" style="position: absolute; right:4em; bottom:0.8em; text-align:right; font-size: 0.85em; vertical-align: middle; opacity: 0.8;" title="(C) Alexander Domanov, 2021"><span id="divUptime">&ndash;</span> |  <a href="update" class="footer_link">ver. <span id="divVersion">210503</span></a></div>
</div></div>
<script type="text/javascript">

    var data = null;
    var first_load = true;

    var is_connected = false;
    var has_popup = false;

    const batt_width = 4.3;
    const voltage_alert = 11.5;
    const reload_timeout = 60000;       // page reload if no data/connection;
    const ping_timeout = 15000;         // timeout for ajax refresh;
    const reboot_timeout = 12000;       // timeout till page will be refresh when reboot the ESP remotely;

    const idx_esp = "esp";
    const idx_gc97 = "gc97";
    const idx_options = "options";

    var xhttp = new XMLHttpRequest();

    function isEnabled(val) {
        return ((val == true) || (val == 1) || (val == "on"));
    }

    function reload() {
        loader(true, "Reloading...");
        document.location.reload(true);
    }

    function callAjax(url, is_json, onRequest) {
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                if (typeof onRequest == "function") {
                    if (is_json) {
                        try {
                            var data = JSON.parse(this.responseText);
                            onRequest(data);
                        } catch (err) {
                            console.log(err.message + " in " + xhttp.responseText);
                            return;
                        }
                    } else {
                        onRequest(this.responseText);
                    }
                }
            }
        };
        xhttp.open("GET", url, true);
        if (is_json) xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send();
    }

    function loadData() {
        loader(true, "Loading&hellip;");
        callAjax("all.json", true, onDataLoaded);
    }

    function onDataLoaded(res) {
        loader(false);
        data = (typeof res != "undefined" && res != null && res != "" && res != {} ? res : null);
        //data = { "status": { "wifi": { "name": "Wireless", "status": true }, "ip": { "name": "192.168.0.141", "status": true }, "mqtt": { "name": "192.168.0.20", "status": true }, "gc97": { "name": "CRC Error", "status": false } }, "battery": { "voltage": 12.12, "current": -1.25, "charging": true, "power": 6.574, "capacity": 24.567, "time": 34124, "soc": 90.5, "temp": 23.45 } };

        is_connected = (data != null && typeof data[idx_gc97] != "undefined" && typeof data[idx_esp] != "undefined" && isEnabled(data[idx_esp]["mqtt"]) && isEnabled(data[idx_esp]["gc97"]));
        showStatus();
        showInfo();
        var nc = document.getElementById("not_connected");
        if ((is_connected)) {
            if ((nc)) nc.classList.add("hidden");
        } else {
            if ((nc) && (data == null || typeof data[idx_esp] == "undefined")) nc.classList.remove("hidden");
            //var f = document.getElementById("footer");
            //if ((f)) f.classList.add("blink_red");
            if (data == null || typeof data[idx_esp] == "undefined" || typeof data[idx_esp]["wifi"] == "undefined" || data[idx_esp]["wifi"]["name"] == "" || !isEnabled(data[idx_esp]["wifi"][idx_esp])) {
                if (first_load) settings(true);
            } else {
                setTimeout(function () {
                    if (!is_connected && !has_popup) reload();
                }, reload_timeout);
            }
        }
        setTimeout(loadData, ping_timeout);
        first_load = false;
    }

    function setStatus(div_id, data_id) {
        var d = document.getElementById(div_id);
        var on = document.querySelector("#" + div_id + " .on");
        var off = document.querySelector("#" + div_id + " .off");
        var lbl = document.querySelector("#" + div_id + " .status-label");
        var has_data = (typeof data[idx_esp] != "undefined" && (data[idx_esp]) && typeof data[idx_esp][data_id] != "undefined");
        var status = {};
        var enabled = false;
        if (has_data) {
            status = data[idx_esp][data_id];
            enabled = isEnabled(status["status"]);
            if ((d)) {
                d.classList.remove("status-gray");
                if (enabled) {
                    d.classList.remove("status-off"); d.classList.add("status-on");
                } else {
                    d.classList.remove("status-on"); d.classList.add("status-off");
                }
            }
        } else {
            if ((d)) {
                d.classList.add("status-gray");
                d.classList.remove("status-off"); d.classList.remove("status-on");
            }
        }
        if ((on) && (on.classList)) { if (has_data && enabled) on.classList.remove("hidden"); else on.classList.add("hidden"); }
        if ((off) && (off.classList)) { if (!has_data || !enabled) off.classList.remove("hidden"); else off.classList.add("hidden"); }
        if ((lbl) && typeof status["name"] != "undefined") lbl.innerHTML = status["name"];

    }

    function showStatus() {
        if (data != null && typeof data[idx_esp] != "undefined") {
            setStatus("wifi", "web");
            setStatus("ip", "wifi");
            setStatus("mqtt", "mqtt");
            setStatus("gc", "gc97");
            var d = document.getElementById("divUptime");
            if ((d) && typeof data[idx_esp]["uptime"] != "undefined") d.innerHTML = "Uptime: " + data[idx_esp]["uptime"]["value"];
            d = document.getElementById("divVersion");
            if ((d) && typeof data[idx_esp]["version"] != "undefined") d.innerHTML = data[idx_esp]["version"];
        }
    }

    function setInfo(div_id, data_id, unit, points) {
        var d = document.getElementById(div_id);
        if ((d)) {
            var has_data = (data != null && typeof data[idx_gc97] != "undefined" && typeof data[idx_gc97][data_id] != "undefined");
            var val = "";
            if (has_data) {
                val = data[idx_gc97][data_id];
                if (points != "undefined" && points != 0) val = parseFloat(val).toFixed(points);
            }
            d.innerHTML = val + (has_data ? "<span class='" + (unit == "%" ? "" : "gc_unit") + "'>" + unit + "</span>" : "");
        }
    }

    function showInfo() {
        var scr = document.getElementById("gc_screen");
        if ((scr)) scr.classList.remove("blink_red");
        if (data != null && typeof data[idx_gc97] != "undefined") {
            if (typeof data[idx_gc97]["time"] != "undefined") {
                var time = new Date(0);
                time.setSeconds(data[idx_gc97]["time"]);
                data[idx_gc97]["time_parsed"] = time.toISOString().substr(11, 8);
            }
            setInfo("gc_temp", "temp", "&deg;C", 1);
            setInfo("gc_batt_perc", "soc", "%", 0);
            setInfo("gc_time", "time_parsed", "", 0);
            setInfo("gc_voltage", "voltage", "V", 1);
            setInfo("gc_current", "current", "A", 2);
            setInfo("gc_power", "power", "W", 3);
            setInfo("gc_capacity", "capacity", "Ah", 3);
            var charging = (typeof data[idx_gc97]["charging"] != "undefined" && (data[idx_gc97]["charging"]));
            var ch = document.getElementById("gc_charging");
            if ((ch)) {
                if (charging) ch.classList.remove("hidden"); else ch.classList.add("hidden");
            }
            var perc = (typeof data[idx_gc97]["soc"] != "undefined" ? data[idx_gc97]["soc"] : 0);
            var soc = document.getElementById("gc_batt_body");
            if ((soc)) {
                var w = (0.2 + batt_width * perc / 100).toFixed(2);
                soc.style.borderLeftWidth = w + "em";
            }
            var volt = parseFloat(typeof data[idx_gc97]["voltage"] != "undefined" ? data[idx_gc97]["voltage"] : 0);
            if ((scr)) {
                scr.classList.remove("offline");
                if (volt > 0 && volt < voltage_alert) scr.classList.add("blink_red");
            }
        } else {
            if ((scr)) scr.classList.add("offline");
        }
    }

    function loader(vis, msg) {
        overlay(vis);
        var b = document.getElementById('preloader');
        if ((b)) {
            if ((vis)) {
                b.classList.add("visible");
                b.classList.remove("hidden");
                var m = document.getElementById('preloader-text');
                if ((m)) m.innerHTML = msg;
            } else {
                b.classList.remove("visible");
                b.classList.add("hidden");
            }
        }
    }

    function overlay(vis) {
        var d = document.getElementById('body');
        if ((d)) {
            if ((vis)) d.classList.add("overlay"); else d.classList.remove("overlay");
        }
        theForm.disabled = !vis;
    }

    function popup(vis, options) {  // options: title, x-close, width, height, buttons
        var d = document.getElementById('popup');
        if ((d)) {
            has_popup = (vis);
            overlay(vis);
            if ((vis)) {
                d.classList.add("visible");
                d.classList.remove("hidden");
                if (options["width"] != "undefined") d.style.width = options["width"];
                if (options["height"] != "undefined") d.style.height = options["height"];
                var hasClose = (typeof options["x-close"] == "undefined" || (options["x-close"]));
                var x = document.getElementById('popup-close');
                if ((x)) {
                    if (hasClose) x.classList.remove("hidden"); else x.classList.add("hidden");
                }
                var title = (typeof options["title"] != "undefined" ? options["title"] : "");
                var h = document.getElementById('popup-header');
                if ((h)) {
                    document.getElementById('popup-header-content').innerHTML = title;
                    if (title != "") {
                        h.classList.remove("hidden");
                    } else {
                        if (!hasClose) h.classList.add("hidden");
                    }
                }
                var buttons = (typeof options["buttons"] != "undefined" ? options["buttons"] : "");
                var b = document.getElementById('popup-buttons');
                if ((b)) {
                    if (buttons != "") {
                        b.classList.remove("hidden");
                        b.innerHTML = buttons;
                    } else {
                        b.classList.add("hidden");
                    }
                }
                return document.getElementById('popup-content')
            } else {
                d.classList.remove("visible");
                d.classList.add("hidden");
            }
        }
    }

    function isIP(ip) {
        if (typeof (ip) !== 'string') return false;
        if (!ip.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)) return false;
        var cnt = 0;
        ip.split('.').filter(function (octect) { var pass = (octect >= 0 && octect <= 255); if (pass) cnt++; return pass });
        return (cnt == 4);
    }

    function saveOptions() {
        var ip = ((theForm.inpMQTT) ? theForm.inpMQTT.value : "");
        if (!isIP(ip)) {
            var options = {
                "title": "Validation",
                "x-close": false,
                "width": "18em",
                "height": "8.5em",
                "buttons": "<div id='btnCancel' class='button' style='margin-left:1ex;width:5em' onclick='settings(false); theForm.inpMQTT.focus(); return false;'>OK</div>"
            };
            var p = popup(true, options);
            if ((p)) {
                p.innerHTML = "<p align=center><b>Error</b>: IP address is not valid.</p>";
            }
            return false;
        }
        var options = {};
        if ((theForm.inpSSID)) options["ssid"] = theForm.inpSSID.value;
        if ((theForm.inpPsw)) options["psw"] = theForm.inpPsw.value;
        if ((theForm.inpMQTT)) options["mqtt"] = theForm.inpMQTT.value;
        if ((theForm.inpTopic)) options["topic"] = theForm.inpTopic.value;
        settings(false);
        loader(true, "Saving data...");
        setTimeout(function () {
            onSaveOptions();
        }, 500);
        return true;
    }

    function onSaveOptions(res) {
        loader(false);
    }

    function reboot() {
        var options = {
            "title": "Confirmation",
            "x-close": false,
            "width": "25em",
            "height": "9em",
            "buttons": "<div id='btnOK' class='button' style='width:5em' onclick='doReboot(); return false'>Reboot</div><div id='btnCancel' class='button button_light' style='margin-left:1ex;width:5em' onclick='settings(false); return false;'>Cancel</div>"
        };
        var p = popup(true, options);
        if ((p)) {
            p.innerHTML = "<p align=center>Do you really want to reboot the ESP controlled?</p>";
        }
        return false;
    }

    function doReboot() {
        loader(true, 'Rebooting. Please wait...');
        callAjax("cmd/reset", null);
        setTimeout(reload, reload_timeout);
    }

    function safeString(val) {
        if (typeof val != "undefined" && val != "") {
            return val.split("'").join("&#39;").split('"').join("&quot;");
        } else {
            return "";
        }
    }

    function addFormRow(title, form_id, data_id) {
        return "<tr><td align=right>" + title + ":</td><td><input type='" + (data_id == "password" ? "password" : "text") + "' id='" + form_id + "' style='width:100%' maxlength=16 value='" + safeString(data != null && typeof data[idx_esp] != "undefined" && typeof data[idx_esp][data_id] != "undefined" ? data[idx_esp][data_id]["name"] : "") + "'></td></tr>";
    }

    function settings(vis) {
        if ((vis)) {
            var options = {
                "title": "Settings",
                "x-close": true,
                "width": "22em",
                "height": "17em",
                "buttons": "<div id='btnOK' class='button disabled' role='button' style='width:5em' disabled='disabled' onclick='saveOptions(); return false'>Save</div><div id='btnCancel' class='button button_light' style='margin-left:1ex;width:5em' onclick='settings(false); return false;'>Cancel</div>"
            };
            var p = popup(true, options);
            if ((p)) {
                var form = "<div class='width:99%; text-align:center; vertical-align:middle;'><table border=0 cellspacing=0 cellpadding=3 style='width:92%; margin-top:1ex'>";
                form += addFormRow("SSID name", "inpSSID", "wifi");
                form += addFormRow("SSID password", "inpPsw", "password");
                form += addFormRow("MQTT server", "inpMQTT", "mqtt");
                form += addFormRow("MQTT port", "inpMQTTPort", "mqtt_port");
                form += addFormRow("MQTT topic", "inpTopic", "mqtt_topic");
                form += "</table></div>";
                p.innerHTML = form;
                if ((theForm.inpMQTT) && theForm.inpMQTT.value == "") theForm.inpMQTT.focus();
                if ((theForm.inpPsw) && theForm.inpPsw.value == "") theForm.inpPsw.focus();
                if ((theForm.inpSSID) && theForm.inpSSID.value == "") theForm.inpSSID.focus();
            }
        } else {
            popup(false);
        }
    }

    window.onload = function () {
        loadData();
    };

</script>
</form></body></html>